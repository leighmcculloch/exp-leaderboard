<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stellar RPC Client Test</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            line-height: 1.6;
        }
        .test-container { 
            margin-bottom: 20px; 
            border: 1px solid #ddd; 
            padding: 15px; 
            border-radius: 5px;
        }
        .test-title { 
            font-weight: bold; 
            color: #333; 
            margin-bottom: 10px;
        }
        .test-result { 
            margin: 5px 0; 
            padding: 8px; 
            border-radius: 3px;
        }
        .success { 
            background-color: #d4edda; 
            color: #155724; 
            border: 1px solid #c3e6cb;
        }
        .error { 
            background-color: #f8d7da; 
            color: #721c24; 
            border: 1px solid #f5c6cb;
        }
        .loading { 
            background-color: #fff3cd; 
            color: #856404; 
            border: 1px solid #ffeaa7;
        }
        .contract-info { 
            background-color: #f8f9fa; 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 3px;
        }
        pre { 
            background: #f4f4f4; 
            padding: 10px; 
            border-radius: 3px; 
            overflow-x: auto;
            font-size: 12px;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <h1>Stellar RPC Client Test Suite</h1>
    <p>This test file validates the Stellar RPC client functions against soroban-testnet.stellar.org</p>
    
    <div class="contract-info">
        <h3>Test Contract Addresses:</h3>
        <ul>
            <li><strong>Native XLM:</strong> CDLZFC3SYJYDZT7K67VZ75HPJVIEUVNIXF47ZG2FB2RMQQAUHKENOWID</li>
            <li><strong>Soroswap Factory:</strong> CBVFAI4TEJCHIICFUYN2C5VYW5TD3CKPIZ4S5P5LVVUWMF5MRLJH77NH</li>
        </ul>
    </div>

    <button onclick="runAllTests()" id="runAllBtn">Run All Tests</button>
    <button onclick="runIndividualTests()" id="runIndividualBtn">Run Individual Tests</button>
    <button onclick="clearResults()" id="clearBtn">Clear Results</button>

    <div id="testResults"></div>

    <script type="module">
        import StellarRPCClient from './stellar-rpc.js';

        // Test contracts
        const TEST_CONTRACTS = {
            nativeXLM: 'CDLZFC3SYJYDZT7K67VZ75HPJVIEUVNIXF47ZG2FB2RMQQAUHKENOWID',
            soroswapFactory: 'CBVFAI4TEJCHIICFUYN2C5VYW5TD3CKPIZ4S5P5LVVUWMF5MRLJH77NH',
            // Add a test contract that might not exist to test error handling
            nonExistent: 'CAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAWHF'
        };

        const client = new StellarRPCClient();
        
        function displayResult(testName, contractAddress, result, error = null) {
            const resultsDiv = document.getElementById('testResults');
            const testContainer = document.createElement('div');
            testContainer.className = 'test-container';
            
            const title = document.createElement('div');
            title.className = 'test-title';
            title.textContent = `${testName} - ${contractAddress}`;
            testContainer.appendChild(title);
            
            const resultDiv = document.createElement('div');
            resultDiv.className = 'test-result';
            
            if (error) {
                resultDiv.className += ' error';
                resultDiv.innerHTML = `
                    <strong>Error:</strong> ${error.message}<br>
                    <pre>${error.stack || error.toString()}</pre>
                `;
            } else {
                resultDiv.className += ' success';
                resultDiv.innerHTML = `
                    <strong>Result:</strong> ${JSON.stringify(result, null, 2)}
                `;
            }
            
            testContainer.appendChild(resultDiv);
            resultsDiv.appendChild(testContainer);
        }

        function displayLoading(testName, contractAddress) {
            const resultsDiv = document.getElementById('testResults');
            const testContainer = document.createElement('div');
            testContainer.className = 'test-container';
            testContainer.id = `loading-${testName}-${contractAddress}`;
            
            const title = document.createElement('div');
            title.className = 'test-title';
            title.textContent = `${testName} - ${contractAddress}`;
            testContainer.appendChild(title);
            
            const resultDiv = document.createElement('div');
            resultDiv.className = 'test-result loading';
            resultDiv.textContent = 'Testing...';
            testContainer.appendChild(resultDiv);
            
            resultsDiv.appendChild(testContainer);
            return testContainer;
        }

        function removeLoading(testName, contractAddress) {
            const loadingElement = document.getElementById(`loading-${testName}-${contractAddress}`);
            if (loadingElement) {
                loadingElement.remove();
            }
        }

        async function testCheckContractDeployed(contractAddress) {
            const testName = 'checkContractDeployed';
            const loadingElement = displayLoading(testName, contractAddress);
            
            try {
                const result = await client.checkContractDeployed(contractAddress);
                removeLoading(testName, contractAddress);
                displayResult(testName, contractAddress, result);
                return result;
            } catch (error) {
                removeLoading(testName, contractAddress);
                displayResult(testName, contractAddress, null, error);
                return false;
            }
        }

        async function testCheckBuildVerified(contractAddress) {
            const testName = 'checkBuildVerified';
            const loadingElement = displayLoading(testName, contractAddress);
            
            try {
                const result = await client.checkBuildVerified(contractAddress);
                removeLoading(testName, contractAddress);
                displayResult(testName, contractAddress, result);
                return result;
            } catch (error) {
                removeLoading(testName, contractAddress);
                displayResult(testName, contractAddress, null, error);
                return false;
            }
        }

        async function testCheckMintEvents(contractAddress) {
            const testName = 'checkMintEvents';
            const loadingElement = displayLoading(testName, contractAddress);
            
            try {
                const result = await client.checkMintEvents(contractAddress);
                removeLoading(testName, contractAddress);
                displayResult(testName, contractAddress, result);
                return result;
            } catch (error) {
                removeLoading(testName, contractAddress);
                displayResult(testName, contractAddress, null, error);
                return false;
            }
        }

        async function testCheckSoroswapPair(contractAddress) {
            const testName = 'checkSoroswapPair';
            const loadingElement = displayLoading(testName, contractAddress);
            
            try {
                const result = await client.checkSoroswapPair(contractAddress);
                removeLoading(testName, contractAddress);
                displayResult(testName, contractAddress, result);
                return result;
            } catch (error) {
                removeLoading(testName, contractAddress);
                displayResult(testName, contractAddress, null, error);
                return false;
            }
        }

        async function testCheckSoroswapSwapped(contractAddress) {
            const testName = 'checkSoroswapSwapped';
            const loadingElement = displayLoading(testName, contractAddress);
            
            try {
                const result = await client.checkSoroswapSwapped(contractAddress);
                removeLoading(testName, contractAddress);
                displayResult(testName, contractAddress, result);
                return result;
            } catch (error) {
                removeLoading(testName, contractAddress);
                displayResult(testName, contractAddress, null, error);
                return false;
            }
        }

        async function testGetFullContractStatus(contractAddress) {
            const testName = 'getFullContractStatus';
            const loadingElement = displayLoading(testName, contractAddress);
            
            try {
                const result = await client.getFullContractStatus(contractAddress);
                removeLoading(testName, contractAddress);
                displayResult(testName, contractAddress, result);
                return result;
            } catch (error) {
                removeLoading(testName, contractAddress);
                displayResult(testName, contractAddress, null, error);
                return {};
            }
        }

        // Test basic RPC connectivity
        async function testBasicRPCConnectivity() {
            const testName = 'Basic RPC Connectivity (getLatestLedger)';
            const loadingElement = displayLoading(testName, 'N/A');
            
            try {
                const result = await client.makeRPCCall('getLatestLedger', {});
                removeLoading(testName, 'N/A');
                displayResult(testName, 'N/A', {
                    sequence: result.sequence,
                    protocolVersion: result.protocolVersion,
                    timestamp: new Date(result.timestamp * 1000).toISOString()
                });
                return result;
            } catch (error) {
                removeLoading(testName, 'N/A');
                displayResult(testName, 'N/A', null, error);
                return null;
            }
        }

        window.runAllTests = async function() {
            const button = document.getElementById('runAllBtn');
            button.disabled = true;
            button.textContent = 'Running Tests...';
            
            clearResults();

            console.log('Starting comprehensive test suite...');
            
            // Test basic connectivity first
            await testBasicRPCConnectivity();
            
            // Test each function with each contract
            for (const [contractName, contractAddress] of Object.entries(TEST_CONTRACTS)) {
                console.log(`Testing contract: ${contractName} (${contractAddress})`);
                
                // Test each function
                await testCheckContractDeployed(contractAddress);
                await testCheckBuildVerified(contractAddress);
                await testCheckMintEvents(contractAddress);
                await testCheckSoroswapPair(contractAddress);
                await testCheckSoroswapSwapped(contractAddress);
                
                // Test the combined function
                await testGetFullContractStatus(contractAddress);
                
                // Add some spacing between contract tests
                console.log(`Completed tests for ${contractName}`);
            }
            
            button.disabled = false;
            button.textContent = 'Run All Tests';
            console.log('Test suite completed!');
        };

        window.runIndividualTests = async function() {
            clearResults();
            
            // Just test the native XLM contract with each function individually
            const contractAddress = TEST_CONTRACTS.nativeXLM;
            
            console.log('Running individual function tests...');
            await testBasicRPCConnectivity();
            await testCheckContractDeployed(contractAddress);
            await testCheckBuildVerified(contractAddress);
            await testCheckMintEvents(contractAddress);
            await testCheckSoroswapPair(contractAddress);
            await testCheckSoroswapSwapped(contractAddress);
            console.log('Individual tests completed!');
        };

        window.clearResults = function() {
            document.getElementById('testResults').innerHTML = '';
        };

        // Auto-run basic connectivity test on load
        window.addEventListener('load', () => {
            setTimeout(() => {
                testBasicRPCConnectivity();
            }, 1000);
        });
    </script>
</body>
</html>